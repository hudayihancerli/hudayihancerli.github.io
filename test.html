<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keşif Oyunu - Geliştirilmiş</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
html,body{margin:0;padding:0;height:100%;overflow:hidden;font-family:'Montserrat',sans-serif;background:#121212;}
#home{height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;}
#statusText{font-size:2.5rem;font-weight:700;margin-bottom:20px;}
#clickableCircle{width:140px;height:140px;border-radius:50%;background:#ff3b3b;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;transition:transform .2s;font-size:1.2rem;}
#clickableCircle:hover{transform:scale(1.1);}
#mapWrap{display:none;width:100vw;height:100vh;position:relative;}
#hud{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:#fff;padding:8px 12px;border-radius:12px;z-index:100;font-weight:700;}
#collection{position:absolute;top:50px;right:10px;width:220px;background:rgba(0,0,0,0.7);padding:10px;border-radius:10px;color:#fff;z-index:100;font-size:0.9rem;max-height:70vh;overflow-y:auto;}
#collection h3{margin:0 0 6px 0;font-size:1rem;text-align:center;}
</style>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>

<div id="home">
  <div id="statusText">Şu anda buradasınız.</div>
  <div id="clickableCircle">Başlat</div>
</div>

<div id="mapWrap">
  <div id="hud">Taşıdığın: <span id="holding">Yok</span></div>
  <div id="collection">
    <h3>Koleksiyon</h3>
    <ul id="collectionList"></ul>
  </div>
  <div id="map" style="width:100%;height:100%;"></div>
</div>

<script>
const startBtn=document.getElementById('clickableCircle');
const home=document.getElementById('home');
const mapWrap=document.getElementById('mapWrap');
const hudHolding=document.getElementById('holding');
const collectionList=document.getElementById('collectionList');

let map, playerMarker, holding=null;
let keys={w:false,s:false,a:false,d:false};
let spacePressed=false;
const PICKUP_RADIUS = 0.004;
const ITEM_RADIUS = 0.003;

let geoData=[
  {id:"item1",type:"Star",color:"gold",coords:[41.037,28.996],target:[41.015137,28.979530],collected:false},
  {id:"item2",type:"Heart",color:"red",coords:[41.035,28.998],target:[41.016,28.981],collected:false},
  {id:"item3",type:"Diamond",color:"blue",coords:[40.744,29.950],target:[40.743,29.948],collected:false},
  {id:"item4",type:"Circle",color:"purple",coords:[40.748,29.952],target:[40.750,29.950],collected:false}
];

// LocalStorage yükleme
try{
  let saved=localStorage.getItem('geoItems');
  if(saved){
    let parsed=JSON.parse(saved);
    if(Array.isArray(parsed)) geoData=parsed;
  }
}catch(e){ console.warn('LocalStorage veri yüklenemedi, varsayılan objeler kullanılıyor.', e); }

startBtn.addEventListener('click',()=>{
  home.style.display='none';
  mapWrap.style.display='block';
  initMap();
});

function initMap(){
  map=L.map('map',{zoomControl:false,scrollWheelZoom:false,dragging:false,doubleClickZoom:false,boxZoom:false,touchZoom:false,keyboard:false})
         .setView([41.015137,28.979530],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  playerMarker=L.circleMarker([41.015137,28.979530],{radius:16,color:'red',fillColor:'red',fillOpacity:1}).addTo(map);

  geoData.forEach(f=>{
    // Çakışma kontrolü
    for(let other of geoData){
      if(other.id !== f.id && dist(f.coords[0],f.coords[1],other.coords[0],other.coords[1])<ITEM_RADIUS){
        f.coords[0] += ITEM_RADIUS; f.coords[1] += ITEM_RADIUS;
      }
    }
    f.marker=L.circleMarker(f.coords,{radius:12,color:f.color,fillColor:f.color,fillOpacity:0.9}).addTo(map)
          .bindTooltip(f.type,{permanent:true,direction:'top'});
    f.targetMarker=L.circleMarker(f.target,{radius:10,color:'lime',fillColor:'lime',fillOpacity:0.6}).addTo(map)
          .bindTooltip(`Hedef: ${f.type}`,{permanent:true,direction:'bottom'});
  });

  updateCollection();
  requestAnimationFrame(loop);
}

// Kontroller
document.body.addEventListener('keydown', e=>{
  switch(e.code){
    case 'KeyW': keys.w=true; break;
    case 'KeyS': keys.s=true; break;
    case 'KeyA': keys.a=true; break;
    case 'KeyD': keys.d=true; break;
    case 'ArrowUp': keys.w=true; break;
    case 'ArrowDown': keys.s=true; break;
    case 'ArrowLeft': keys.a=true; break;
    case 'ArrowRight': keys.d=true; break;
    case 'Space':
      if(!spacePressed){
        spacePressed=true;
        if(!holding){
          // Yakın nesneye al
          for(let f of geoData){
            if(!f.collected && dist(player.lat,player.lng,f.coords[0],f.coords[1]) < PICKUP_RADIUS){
              holding=f;
              hudHolding.textContent=f.type;
              f.marker.setStyle({radius:16,opacity:0.7});
              break;
            }
          }
        } else {
          // Nesneyi bırak
          holding.marker.setStyle({radius:12,opacity:1});
          holding = null;
          hudHolding.textContent='Yok';
          saveData();
          updateCollection();
        }
      }
      break;
  }
});
document.body.addEventListener('keyup', e=>{ if(e.code==='Space') spacePressed=false;
  switch(e.code){ case 'KeyW': keys.w=false; break; case 'KeyS': keys.s=false; break; case 'KeyA': keys.a=false; break; case 'KeyD': keys.d=false; break; case 'ArrowUp': keys.w=false; break; case 'ArrowDown': keys.s=false; break; case 'ArrowLeft': keys.a=false; break; case 'ArrowRight': keys.d=false; break; }});

let player={lat:41.015137,lng:28.979530,spd:0.0008};

function loop(){
  if(keys.w) player.lat+=player.spd;
  if(keys.s) player.lat-=player.spd;
  if(keys.a) player.lng-=player.spd;
  if(keys.d) player.lng+=player.spd;

  playerMarker.setLatLng([player.lat,player.lng]);
  map.setView([player.lat,player.lng]);

  if(holding) holding.marker.setLatLng([player.lat,player.lng]);

  requestAnimationFrame(loop);
}

function dist(lat1,lng1,lat2,lng2){return Math.hypot(lat1-lat2,lng1-lng2);}

function updateCollection(){
  collectionList.innerHTML='';
  geoData.forEach(f=>{
    if(f.collected){
      let li=document.createElement('li');
      li.textContent=f.type;
      collectionList.appendChild(li);
    }
  });
}

function saveData(){
  try{
    let safeData=geoData.map(f=>({id:f.id,type:f.type,color:f.color,coords:f.coords,target:f.target,collected:f.collected}));
    localStorage.setItem('geoItems',JSON.stringify(safeData));
  }catch(e){ console.warn('LocalStorage kaydedilemedi.',e); }
}
</script>
</body>
</html>
